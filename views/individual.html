<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Results Manager</title>
    <style type='text/css'>
      body {
        font-family: Roboto;
      }
      .item {
        cursor: pointer;
      }
      .bold {
        font-weight: bold;
      }
      ul {
        padding-left: 1em;
        line-height: 1.5em;
        list-style-type: none;
      }

      .attachment-image {
        border: 1px solid black;
      }

      .snippet {
        font-family: Oxygen Mono;
        display: inline-block;
        white-space: pre-wrap;
        font-size: 100%;
        width: auto;
        padding: 4px;
        border: 1px solid #D6D5D3;
        border-radius: 5px;
        background: #FBFAF8;
      }
      .hljs {
        background: #FBFAF8 !important;
      }
    </style>
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons|Oxygen+Mono' rel='stylesheet' type='text/css'>
    <link href='https://unpkg.com/vuetify/dist/vuetify.min.css' rel='stylesheet' type='text/css'>
    <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css' rel='stylesheet' type='text/css'>
    <script src='https://unpkg.com/vue/dist/vue.js'></script>
    <script src='https://unpkg.com/vuetify/dist/vuetify.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js'></script>
    <script>
function eventWindowLoaded() {
Vue.use(Vuetify);

Vue.directive('highlightjs', {
  deep: true,
  bind: function(el, binding) {
    // on first bind, highlight all targets
    let targets = el.querySelectorAll('.code-highlight')
    targets.forEach((target) => {
      // if a value is directly assigned to the directive, use this
      // instead of the element content.
      if (binding.value) {
        target.textContent = binding.value
      }
      hljs.highlightBlock(target)
    })
  },
  componentUpdated: function(el, binding) {
    // after an update, re-fill the content and then highlight
    let targets = el.querySelectorAll('.code-highlight')
    targets.forEach((target) => {
      if (binding.value) {
        target.textContent = binding.value
        hljs.highlightBlock(target)
      }
    })
  }
});

Vue.component('test-item', {
  template: '#item-template',
  props: {
    model: Object
  },
  data: function () {
    return {
      open: (this.model.name || this.model.state === 'failed') ? true : false
    }
  },
  computed: {
    isFolder: function () {
      if (this.model.children && this.model.children.length) {
        return true;
      }
      if (this.model.attachments && this.model.attachments.length) {
        return true;
      }
      if (this.model.code || this.model.stack) {
        return true;
      }
      return false;
    },
    isRoot: function () {
      return this.model.name;
    },
    passed: function() {
      return this.model.state === 'passed';
    },
    failed: function() {
      return this.model.state === 'failed';
    },
    skipped: function() {
      return this.model.state === 'skipped';
    },
    duration: function() {
      if (this.model.duration) {
        if (this.model.duration > 60000) {
          return '(' + (this.model.duration / 60000).toFixed(1) + ' m)';
        } else if (this.model.duration > 1000) {
          return '(' + (this.model.duration / 1000).toFixed(1) + ' s)';
        } else {
          return '(' + this.model.duration + ' ms)';
        }
      } else {
        return '';
      }
    },
    color: function() {
      if (this.model.state === 'passed') {
        return 'green';
      } else if (this.model.state === 'failed') {
        return 'red';
      } else {
        return 'blue';
      }
    },
    command: function() {
      if (this.model.type === 'protractor') {
        return 'ptor';
      } else if (this.model.type === 'mocha') {
        return 'mocha';
      } else {
       return '';
      }
    },
    timestamp: function() {
      return moment(this.model.timestamp).calendar();
    },
   type: function() {
     if (this.model.buildType === 'main') {
       return 'jenkins';
     } else {
       return this.model.buildType;
     }
   }
  },
  methods: {
    toggle: function () {
      if (this.isFolder) {
        this.open = !this.open
      }
    }
  },
  filters: {
    fastFail: function(value) {
      return value.replace(/\s+\#fastFail/, '');
    },
    capitalize: function(value) {
      return value[0].toUpperCase() + value.substring(1);
    }
  },
});

Vue.component('test-result', {
  template: '<v-row v-if="!report.loading"><v-col xs12="xs12"><ul><test-item :model="report"></test-item></ul></v-col></v-row>',
  props: {
    report: Object
  },
  computed: {
    title: function() {
      if (this.report.title) {
        return this.report.title;
      } else {
        return 'Loading...';
      }
    }
  },
  data: function() {
    return {}
  },
  methods: {}
});

var app = new Vue({
  el: '#app',
  data: {
    report: {
      loading: true
    },
    sidebar: false
  },
  created: function() {
    this.getData();
  },
  methods: {
    getData: function() {
      var vm = this;
      var dataUrl = window.location.pathname.replace('/view/', '/data/');
      return axios.get(dataUrl).
        then(function(response) {
          console.log(response);
          vm.report = response.data;
          vm.title = response.data.title;
          return response;
        });
    }
  }
});
}
window.addEventListener('load', eventWindowLoaded, false);
    </script>
    <script src="https://unpkg.com/axios@0.12.0/dist/axios.min.js"></script>
    <script type="text/x-template" id="item-template">
      <li>
        <div v-if="isRoot">
          <v-breadcrumbs divider="/">
            <v-breadcrumbs-item :href="model.buildUrl">{{type}}</v-breadcrumbs-item>
            <v-breadcrumbs-item>{{ model.job }}</v-breadcrumbs-item>
            <v-breadcrumbs-item>{{ model.build }}</v-breadcrumbs-item>
            <v-breadcrumbs-item>{{ model.type }}</v-breadcrumbs-item>
            <v-breadcrumbs-item>{{ model.name }}</v-breadcrumbs-item>
          </v-breadcrumbs>
          <h4>
            <span class="grey--text text--darken-2">[{{model.type | capitalize}}]</span> {{model.title | fastFail}}
            <v-chip small :class="color" class="white--text">
              {{model.state | capitalize}}
            </v-chip>
          </h4>
          <div v-if="failed">Reproduce locally: <span class="snippet ">$ {{command}} {{model.name}}</span><br><br></div>
          <span :class="{bold: isFolder}">{{model.title | fastFail}}</span> {{duration}}
        </div>
        <div v-if="!isRoot" @click="toggle">
          <span v-if="passed" class="green--text">&#10004;</span>
          <span v-else-if="skipped" class="cyan--text text--lighten-1">&#8212;</span>
          <span v-else-if="failed" class="red--text">&#10006;</span>
          <span :class="{bold: isFolder}">{{model.title | fastFail}}</span> {{duration}}
          <span v-if="isFolder"><i class="pl-2 fa" :class="{'fa-plus-square-o': !open, 'fa-minus-square-o': open }"></i></span>
        </div>
        <ul v-show="open" v-if="isFolder">
          <li class="pl-3" v-for="attachment in model.attachments">
            <div class="bold">{{attachment.title}}</div>
            <img :src="'data:image/png;base64,' + attachment.data" class="attachment-image">
          </li>
          <li class="pl-3" v-for="error in model.errors">
            Stack:<br>
            <pre class="snippet ">{{error.stack}}</pre>
          </li>
          <li class="pl-3" v-if="model.code">
            Code:<br>
            <pre class="snippet" v-highlightjs="model.code"><div class="code-highlight javascript"></div></pre>
          </li>
          <test-item class="item" v-for="model in model.children" :model="model" :key="model.title"></test-item>
          </ul>
          <div v-if="isRoot">
            <v-chip label class="white">
              <v-avatar class="grey--text">
                <v-icon>event</v-icon>
              </v-avatar>
              {{timestamp}}
            </v-chip>
          </div>
      </li>
    </script>
  </head>
  <body>
    <v-app id="app" top-toolbar>
      <v-toolbar>
        <v-toolbar-title>Onshape Results Manager</v-toolbar-title>
      </v-toolbar>
      <main>
        <v-content>
          <v-container fluid>
            <test-result :report="report"></test-result>
          </v-container>
        </v-content>
      </main>
    </v-app>
  </body>
</html>
